#! /usr/bin/env ruby

require 'yaml'
require 'task_report'

def show_usage_message(exit_status = 0)
  puts \
"Use `task` as follows:

  `task start TASK-DESCRIPTION`
    - finds or creates a new gist for today
    - adds a new item with the provided TASK-DESCRIPTION

  `task stop`
    - stops time tracking the current task, if it exists

  `task continue [TASK-ID, TASK-DESCRIPTION]`
    - continues tracking the provided task, or latest task if none if provided

  `task current`
    - lists the currently ongoing task

  `task list`
    - Lists all of today's tasks

  `task summary`
    - prints a task summary to the command line

  `task delete {TASK-ID, TASK-DESCRIPTION, today, gist}`
    - deletes the provided task if it exists
    - if 'today' is passed, then all tasks in today's report will be deleted
    - if 'gist' is passed, then the whole report gist for today will be deleted

  `task help`
    - shows this message"

  exit exit_status
end

begin
  config_path = File.expand_path('~/.task_report_config')
  config = YAML.load(File.read(config_path))
  TaskReport::User.name = config.fetch('user')
  TaskReport::User.api_token = config.fetch('personal_access_token')
rescue Errno::ENOENT
  puts 'Config file not found. It should be located at ~/.task_report_config.'
  puts 'See https://github.com/mpataki/task_report for help.'
  puts 'Exiting'
  exit 1
rescue Psych::SyntaxError
  puts 'The config file must be valid yaml syntax.'
  puts 'Exiting'
  exit 1
rescue KeyError
  puts 'Config key not found.'
  puts 'Required configuration keys are `user` and `personal_access_token`'
  puts 'See an example at https://github.com/mpataki/task_report'
  puts 'Exiting'
  exit 1
end

case ARGV[0]
when 'list'
  TaskReport.list
when 'start'
  TaskReport.start(ARGV[1])
when 'stop'
  TaskReport.stop
when 'continue'
  TaskReport.continue(ARGV[1])
when 'delete'
  TaskReport.delete(ARGV[1])
when 'current'
  TaskReport.current
when 'summary'
  TaskReport.summary
# when 'info'
else
  show_usage_message
end
